<!DOCTYPE html>
<html lang="en">
<head>
    <title>AI Draw and Guess</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
</head>

<body>
<h1>
    Username: <span id="user_name">{{ user_name }}</span>
    <br>
    GameId: <span id="game_id">{{ game_id }}</span>
    <br>
    Round: <span id="round_id">{{ round_id }}</span>
    <br>
    Drawer: <span id="drawer_name">{{ drawer_name }}</span>
</h1>

<div id="display">Waiting for drawer {{ drawer_name }} to enter a sentence...</div>

<form action="" method="POST">
    <input type="text" class="sentence" placeholder="Enter a sentence"/>
    <input type="submit"/>
</form>

<script type="text/javascript">
    var game_id = $('#game_id').text()
    var user_name = $('#user_name').text()

    var socket = io.connect('http://' + document.domain + ':' + location.port);

    $('form').on('submit', function(e) {
      e.preventDefault()
      var sentence = $('input.sentence').val()
      var drawer_name = $('#drawer_name').text()
      if (drawer_name == user_name) {
          socket.emit('drawer-submit-event', {
              game_id: game_id,
              user_name: user_name,
              sentence: sentence
          })
      } else {
         socket.emit('guesser-submit-event', {
              game_id: game_id,
              user_name: user_name,
              sentence: sentence
          })
      }

      $('input.sentence').val('').focus()
    })

    socket.on('drawer-submit-event-response', function(msg) {
      console.log(msg)
      if (typeof msg !== 'undefined') {
          $('#display').empty()
          $('#display').append('<div><b style="color: #000">' + msg.user_name + '</b> ' + msg.sentence + '</div>')
      }
    })

    socket.on('ai-returns-image-event', function(data) {
      $('#display').append("<div><img width='600' height='400' src='data:image/png;base64, " + data + "'/></div>")
    })

    socket.on('round-end-event', function(data) {
      var round_id = data.round_id
      $('#display').append(`<div>Round ${round_id} ended!</div>`)
    })

    socket.on('guesser-submit-event-response', function(msg) {
      console.log(msg)
      if (typeof msg !== 'undefined') {
          $('#display').append(
            `<div>Guesser: <b>${msg.user_name}</b> score: ${msg.score} Sentence: ${msg.sentence}</div>`
           )
      }
    })

    // Refresh page to the next round
    socket.on('start-new-round-event', function(msg) {
        $('#display').empty()
        $('#display').append(`<div>Started round ${msg.round_id}</div>`)
        $('#display').append(`<div>Waiting for drawer ${msg.drawer_name} to enter a sentence</div>`)
        $('#round_id').text(msg.round_id)
        $('#drawer_name').text(msg.drawer_name)
    })

</script>

</body>
</html>
